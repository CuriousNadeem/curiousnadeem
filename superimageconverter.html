<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Super Image Converter</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f8f9fa;
      }
      #dropArea {
        border: 2px dashed #6c757d;
        padding: 60px;
        text-align: center;
        background-color: #fff;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
      }
      #dropArea.dragover {
        background-color: #e9ecef;
      }
    </style>
  </head>
  <body>
    <div class="container my-5">
      <!-- Title -->
      <h1 class="text-center mb-4">Super Image Converter</h1>

      <!-- Upload Controls -->
      <div class="text-center mb-3">
        <button id="uploadButton" class="btn btn-primary">Upload Images</button>
        <p class="text-muted mt-2">
          You can upload up to <strong>300 files</strong> at once (Max 100MB
          each)
        </p>
      </div>

      <!-- Drag & Drop Area -->
      <div id="dropArea" class="mb-4">
        <p class="mb-0">Drag and drop image files here</p>
      </div>

      <!-- Hidden File Input -->
      <input type="file" id="fileInput" accept="image/*" multiple hidden />

      <!-- Selected Images Table -->
      <div class="table-responsive">
        <table
          class="table table-striped align-middle text-center"
          id="imagesTable"
        >
          <thead class="table-dark">
            <tr>
              <th scope="col">File Name</th>
              <th scope="col">Current Type</th>
              <th scope="col">Convert To</th>
              <th scope="col">Convert</th>
              <!-- NEW -->
              <th scope="col">Download</th>
              <!-- NEW -->
            </tr>
          </thead>

          <tbody id="imagesTableBody">
            <tr>
              <td colspan="5" class="text-muted">No images selected</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script>
      const dropArea = document.getElementById("dropArea");
      const fileInput = document.getElementById("fileInput");
      const uploadButton = document.getElementById("uploadButton");
      const imagesTableBody = document.getElementById("imagesTableBody");

      // Drag over effect
      dropArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropArea.classList.add("dragover");
      });
      dropArea.addEventListener("dragleave", () =>
        dropArea.classList.remove("dragover")
      );
      dropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        dropArea.classList.remove("dragover");
        handleFiles(e.dataTransfer.files);
      });

      // Upload button click
      uploadButton.addEventListener("click", () => fileInput.click());

      // File input change
      fileInput.addEventListener("change", () => handleFiles(fileInput.files));

      // --- Conversion Helper Function ---
      function convertImage(
        file,
        targetFormat,
        convertBtn,
        downloadBtn,
        store
      ) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);

          reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;

            img.onload = () => {
              const canvas = document.createElement("canvas");
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0);

              const formatMap = {
                jpg: "image/jpeg",
                jpeg: "image/jpeg",
                png: "image/png",
                webp: "image/webp",
                gif: "image/gif",
                bmp: "image/bmp",
                tiff: "image/tiff",
                avif: "image/avif",
              };
              const mimeType = formatMap[targetFormat] || "image/png";

              canvas.toBlob(
                (blob) => {
                  if (!blob) {
                    reject(new Error("Conversion failed"));
                    return;
                  }

                  const url = URL.createObjectURL(blob);

                  // Enable individual download
                  downloadBtn.disabled = false;
                  downloadBtn.textContent = "Download";
                  downloadBtn.onclick = () => {
                    const a = document.createElement("a");
                    a.href = url;
                    a.download =
                      file.name.replace(/\.[^/.]+$/, "") + "." + targetFormat;
                    a.style.display = "none";
                    a.target = "_blank"; // prevent reload/navigation
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                      document.body.removeChild(a);
                      URL.revokeObjectURL(url);
                    }, 100);
                  };

                  // Save for ZIP download
                  store.push({
                    name:
                      file.name.replace(/\.[^/.]+$/, "") + "." + targetFormat,
                    blob,
                  });

                  convertBtn.textContent = "Converted ✔";
                  resolve();
                },
                mimeType,
                0.95
              );
            };
          };

          reader.onerror = reject;
        });
      }

      // Handle uploaded files
      function handleFiles(files) {
        if (!files.length) return;

        imagesTableBody.innerHTML = "";

        const convertedFiles = []; // will store all blobs for zip

        [...files].forEach((file) => {
          const row = document.createElement("tr");

          // File Name
          const nameCell = document.createElement("td");
          nameCell.textContent = file.name;

          // Current Type
          const typeCell = document.createElement("td");
          const ext = file.name.split(".").pop().toLowerCase();
          typeCell.textContent = ext;

          // Convert To
          const convertCell = document.createElement("td");
          const select = document.createElement("select");
          select.classList.add("form-select", "form-select-sm");
          select.innerHTML = `
        <option value="">None</option>
        <option value="jpg">JPG</option>
        <option value="jpeg">JPEG</option>
        <option value="png">PNG</option>
        <option value="webp">WebP</option>
        <option value="gif">GIF</option>
        <option value="bmp">BMP</option>
        <option value="tiff">TIFF</option>
        <option value="avif">AVIF</option>
      `;
          convertCell.appendChild(select);

          // Convert Btn
          const convertCellBtn = document.createElement("td");
          const convertBtn = document.createElement("button");
          convertBtn.classList.add("btn", "btn-sm", "btn-primary");
          convertBtn.textContent = "Convert";
          convertBtn.disabled = true;
          convertCellBtn.appendChild(convertBtn);

          // Download Btn
          const downloadCellBtn = document.createElement("td");
          const downloadBtn = document.createElement("button");
          downloadBtn.classList.add("btn", "btn-sm", "btn-success");
          downloadBtn.textContent = "Download";
          downloadBtn.disabled = true;
          downloadCellBtn.appendChild(downloadBtn);

          row.appendChild(nameCell);
          row.appendChild(typeCell);
          row.appendChild(convertCell);
          row.appendChild(convertCellBtn);
          row.appendChild(downloadCellBtn);
          imagesTableBody.appendChild(row);

          // Enable convert when format chosen
          select.addEventListener("change", () => {
            convertBtn.disabled = select.value === "";
          });

          // Individual convert
          convertBtn.addEventListener("click", async () => {
            if (!select.value) return;
            convertBtn.disabled = true;
            convertBtn.textContent = "Converting...";
            await convertImage(
              file,
              select.value,
              convertBtn,
              downloadBtn,
              convertedFiles
            );
          });
        });

        // Bulk "Set All" row
        const bulkRow = document.createElement("tr");
        const labelCell = document.createElement("td");
        labelCell.textContent = "Apply to All";
        labelCell.classList.add("fw-bold");

        const dashCell = document.createElement("td");
        dashCell.textContent = "-";

        const bulkCell = document.createElement("td");
        const bulkSelect = document.createElement("select");
        bulkSelect.classList.add("form-select", "form-select-sm");
        bulkSelect.innerHTML = `
      <option value="">None</option>
      <option value="jpg">JPG</option>
      <option value="jpeg">JPEG</option>
      <option value="png">PNG</option>
      <option value="webp">WebP</option>
      <option value="gif">GIF</option>
      <option value="bmp">BMP</option>
      <option value="tiff">TIFF</option>
      <option value="avif">AVIF</option>
    `;
        bulkCell.appendChild(bulkSelect);

        // Convert All
        const convertAllCell = document.createElement("td");
        const convertAllBtn = document.createElement("button");
        convertAllBtn.classList.add("btn", "btn-sm", "btn-primary");
        convertAllBtn.textContent = "Convert All";
        convertAllBtn.disabled = true;
        convertAllCell.appendChild(convertAllBtn);

        // Download All
        const downloadAllCell = document.createElement("td");
        const downloadAllBtn = document.createElement("button");
        downloadAllBtn.classList.add("btn", "btn-sm", "btn-success");
        downloadAllBtn.textContent = "Download All (ZIP)";
        downloadAllBtn.disabled = true;
        downloadAllCell.appendChild(downloadAllBtn);

        bulkRow.appendChild(labelCell);
        bulkRow.appendChild(dashCell);
        bulkRow.appendChild(bulkCell);
        bulkRow.appendChild(convertAllCell);
        bulkRow.appendChild(downloadAllCell);
        imagesTableBody.appendChild(bulkRow);

        // Apply-to-all select
        bulkSelect.addEventListener("change", () => {
          const rows = imagesTableBody.querySelectorAll("tr");
          rows.forEach((row) => {
            const dropdown = row.querySelector("select");
            const convertBtn = row.querySelector("button.btn-primary");
            if (dropdown && convertBtn) {
              dropdown.value = bulkSelect.value;
              convertBtn.disabled = bulkSelect.value === "";
            }
          });
          convertAllBtn.disabled = bulkSelect.value === "";
        });

        // Convert All
        convertAllBtn.addEventListener("click", async () => {
          convertAllBtn.disabled = true;
          convertAllBtn.textContent = "Converting...";

          const rows = [...imagesTableBody.querySelectorAll("tr")].slice(0, -1); // skip bulk row
          for (const row of rows) {
            const fileName = row.cells[0].textContent;
            const dropdown = row.querySelector("select");
            const convertBtn = row.querySelector("button.btn-primary");
            const downloadBtn = row.querySelector("button.btn-success");

            if (dropdown.value && convertBtn.textContent === "Convert") {
              convertBtn.disabled = true;
              convertBtn.textContent = "Converting...";
              const file = [...files].find((f) => f.name === fileName);
              await convertImage(
                file,
                dropdown.value,
                convertBtn,
                downloadBtn,
                convertedFiles
              );
            }
          }

          convertAllBtn.textContent = "Converted ✔";
          downloadAllBtn.disabled = false;
        });

        // Download All (ZIP)
        downloadAllBtn.addEventListener("click", async () => {
          const zip = new JSZip();
          convertedFiles.forEach((item) => {
            zip.file(item.name, item.blob);
          });
          const blob = await zip.generateAsync({ type: "blob" });
          saveAs(blob, "converted_images.zip");
        });
      }
    </script>
  </body>
</html>

